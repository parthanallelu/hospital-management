{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card p-4 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Medical History: {{ patient.name }}</h2>
                <a href="{{ url_for('doctor.dashboard') }}" class="btn btn-outline-secondary">Back to Dashboard</a>
            </div>
        </div>

        <!-- AI Assistant Section -->
        <div class="card p-4 my-4 border-0 shadow-sm"
            style="background: linear-gradient(145deg, #ffffff 0%, #f0f7ff 100%);">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-primary"><i class="fas fa-robot me-2"></i>AI Clinical Assistant</h4>
                <span class="badge bg-primary">Beta</span>
            </div>

            <div class="input-group mb-3">
                <input type="text" id="ai-query" class="form-control"
                    placeholder="Ask about patient history, trends, or summary (e.g. 'Show LDL trend')">
                <button class="btn btn-primary" type="button" onclick="askAI()">Ask AI</button>
            </div>

            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-sm btn-outline-secondary"
                    onclick="setQuery('Summarize medical history')">Summarize History</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setQuery('Show LDL trend')">Show LDL
                    Trend</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setQuery('Analyze lifestyle risks')">Analyze
                    Risks</button>
            </div>

            <div id="ai-loading" class="d-none text-center my-3">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted small mt-1">Analyzing clinical data...</p>
            </div>

            <div id="ai-result" class="d-none bg-white p-3 rounded border">
                <div id="ai-text-content"></div>
                <div id="ai-chart-container" class="mt-3"
                    style="position: relative; height:300px; width:100%; display: none;">
                    <canvas id="aiChart"></canvas>
                </div>
                <p id="ai-disclaimer" class="text-muted small mt-2 fst-italic"></p>
            </div>
        </div>

        <!-- Patient Details & History -->
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs mb-4" id="historyTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general"
                type="button">General History</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="appts-tab" data-bs-toggle="tab" data-bs-target="#appts"
                type="button">Appointments</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">Audit
                Log</button>
        </li>
    </ul>

    <div class="tab-content" id="historyTabContent">
        <!-- General History Tab -->
        <div class="tab-pane fade show active" id="general">
            <div class="d-flex justify-content-between mb-3">
                <h5>General Medical Records</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addHistoryModal">
                    <i class="fas fa-plus"></i> Add Record
                </button>
            </div>

            {% if history_records %}
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Condition</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in history_records %}
                        <tr>
                            <td>{{ record.date.strftime('%Y-%m-%d') if record.date else 'N/A' }}</td>
                            <td><strong>{{ record.title }}</strong></td>
                            <td>{{ record.description }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">No records found.</div>
            {% endif %}
        </div>

        <!-- Appointments Tab -->
        <div class="tab-pane fade" id="appts">
            {% if appointments %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Doctor</th>
                            <th>Symptoms</th>
                            <th>Prescription</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appt in appointments %}
                        <tr>
                            <td>{{ appt.slot.start_time.strftime('%Y-%m-%d') if appt.slot and appt.slot.start_time else
                                'N/A' }}</td>
                            <td>{{ appt.doctor.name }}</td>
                            <td>{{ appt.symptoms }}</td>
                            <td>
                                {% if appt.prescription %}
                                <ul class="mb-1 ps-3">
                                    {% for item in appt.prescription.items %}
                                    <li>{{ item.medicine }} ({{ item.dosage }})</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>No appointments found.</p>
            {% endif %}
        </div>

        <!-- Audit Log Tab -->
        <div class="tab-pane fade" id="logs">
            <h5 class="mb-3">Activity Log</h5>
            {% if logs %}
            <ul class="list-group">
                {% for log in logs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ log.action }}</strong>
                        <br>
                        <small class="text-muted">By {{ log.performed_by }}</small>
                    </div>
                    <span class="badge bg-light text-dark">{{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No activity recorded yet.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add History Modal -->
<div class="modal fade" id="addHistoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Medical Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('doctor.add_history_record', patient_id=patient.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title / Condition</label>
                        <input type="text" name="title" class="form-control" required
                            placeholder="e.g. Type 2 Diabetes">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-control" required
                            value="{{ now().strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description / Results</label>
                        <textarea name="description" class="form-control" rows="3" required
                            placeholder="Details..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Record</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function setQuery(q) {
        document.getElementById('ai-query').value = q;
        askAI();
    }

    async function askAI() {
        const queryInput = document.getElementById('ai-query');
        const query = queryInput.value;
        if (!query) return;

        // UI Reset
        document.getElementById('ai-loading').classList.remove('d-none');
        document.getElementById('ai-result').classList.add('d-none');
        document.getElementById('ai-chart-container').style.display = 'none';

        const chartCanvas = document.getElementById('aiChart');
        const chartInstance = Chart.getChart(chartCanvas);
        if (chartInstance) {
            chartInstance.destroy();
        }

        try {
            const response = await fetch('/ai/insight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patient_id: "{{ patient.id }}",
                    query: query
                })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();

            document.getElementById('ai-loading').classList.add('d-none');
            document.getElementById('ai-result').classList.remove('d-none');

            // Handle different AI modes
            let htmlContent = '';

            if (data.summary) {
                htmlContent = `
                    <div class="mb-2"><strong>Summary:</strong> ${data.summary}</div>
                    ${data.key_conditions ? `<div class="mb-2"><small class='text-muted'>Key Conditions:</small> <span class='badge bg-info'>${data.key_conditions.join('</span> <span class=\'badge bg-info\'>')}</span></div>` : ''}
                    ${data.current_medications ? `<div class="mb-2"><small class='text-muted'>Meds:</small> ${data.current_medications.join(', ')}</div>` : ''}
                `;
            } else if (data.answer) {
                htmlContent = `
                    <div class="d-flex justify-content-between">
                        <strong>Answer:</strong>
                        ${data.confidence_level ? `<span class="badge bg-${data.confidence_level === 'HIGH' ? 'success' : 'warning'}">${data.confidence_level} Confidence</span>` : ''}
                    </div>
                    <p class="mt-1">${data.answer}</p>
                `;
            } else if (data.interpretation || data.chart_type) {
                htmlContent = `
                    <strong>Analysis:</strong> ${data.interpretation || 'Graph generated below.'}
                    ${data.reference_range ? `<br><small class="text-muted">Ref Range: ${data.reference_range.min} - ${data.reference_range.max}</small>` : ''}
                `;
            }

            document.getElementById('ai-text-content').innerHTML = htmlContent;
            document.getElementById('ai-disclaimer').innerText = data.disclaimer || "AI generated content.";

            // Render Chart if graph_instruction
            if (data.chart_type) {
                document.getElementById('ai-chart-container').style.display = 'block';
                renderChart(data);
            }

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('ai-loading').classList.add('d-none');
            alert("Failed to get AI insight. Please try again.");
        }
    }

    function renderChart(data) {
        const ctx = document.getElementById('aiChart');

        // Use backend provided graph data if available
        const chartData = data.graph_data || {
            labels: ['No Data'],
            datasets: [{ label: 'No Data', data: [] }]
        };

        new Chart(ctx, {
            type: data.chart_type || 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

    }
</script>
{% endblock %}