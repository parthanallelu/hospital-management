{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-primary mb-3">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Dr. {{ prescription.appointment.doctor.name }}</h4>
                <div>
                    <button onclick="window.print()" class="btn btn-light btn-sm"><i class="fas fa-file-pdf"></i> Save
                        as PDF</button>
                    <small class="ms-2">{{ prescription.created_at.strftime('%d %B %Y') }}</small>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Doctor Details</h6>
                        <p class="mb-0">{{ prescription.appointment.doctor.name }}</p>
                        <p class="mb-0">{{ prescription.appointment.doctor.qualification }}</p>
                        <p class="mb-0">{{ prescription.appointment.doctor.specialty }}</p>
                        <p class="text-muted">{{ prescription.appointment.doctor.clinic_address }}</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <h6>Patient Details</h6>
                        <p class="mb-0">{{ prescription.appointment.patient.name }}</p>
                        <p class="mb-0">Gender: {{ prescription.appointment.patient.gender }}</p>
                    </div>
                </div>

                <hr>

                <form action="{{ url_for('patient.order_medicines', prescription_id=prescription.id) }}" method="POST">
                    <h5 class="card-title mt-4">Rx - Select Medicines to Order</h5>
                    <div class="p-3 bg-light rounded">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th class="text-center">Select</th>
                                        <th>Medicine</th>
                                        <th>Dosage</th>
                                        <th>Frequency</th>
                                        <th>Timing</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in prescription.items %}
                                    <tr>
                                        <td class="text-center">
                                            <input class="form-check-input" type="checkbox" name="selected_items"
                                                value="{{ item.id }}" checked>
                                        </td>
                                        <td><strong>{{ item.medicine }}</strong></td>
                                        <td>{{ item.dosage }}</td>
                                        <td>{{ item.frequency }}</td>
                                        <td><span class="badge bg-info text-dark">{{ item.timing or 'N/A' }}</span></td>
                                        <td>{{ item.duration }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <h6 class="mt-4">Instructions</h6>
                    <p class="lead">{{ prescription.instructions }}</p>

                    <div class="mt-4 p-3 border rounded bg-white">
                        <h5>Order Options</h5>
                        <div class="mb-3">
                            <label class="form-label">Delivery Method</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="delivery_type" id="del1"
                                    value="delivery" checked>
                                <label class="form-check-label" for="del1">
                                    Home Delivery (to {{ current_user.patient_profile.address or 'Profile Address' }})
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="delivery_type" id="del2"
                                    value="pickup">
                                <label class="form-check-label" for="del2">
                                    Store Pickup (Come to Pharmacy)
                                </label>
                            </div>
                        </div>

                        <!-- Delivery Location Map -->
                        <div id="deliveryMapContainer" class="mb-3" style="display: none;">
                            <label class="form-label">Search or Pin Location</label>
                            <div id="deliveryMap" class="border rounded" style="height: 300px;"></div>
                            <small class="text-muted">Drag marker to pinpoint location.</small>

                            <div class="mt-3">
                                <label class="form-label">Detailed Address / Notes</label>
                                <textarea name="delivery_address" class="form-control"
                                    rows="2">{{ current_user.patient_profile.address or '' }}</textarea>
                            </div>

                            <!-- Hidden Inputs for Coordinates -->
                            <input type="hidden" name="lat" id="lat">
                            <input type="hidden" name="lng" id="lng">
                        </div>

                        <!-- Pharmacy Map for Pickup -->
                        <div id="pharmacyMap" class="mt-3 mb-3 border rounded" style="display: none; height: 300px;">
                        </div>
                        <div id="pharmacyDirBtn" class="mb-3 text-end" style="display: none;">
                            <a href="https://www.google.com/maps/dir/?api=1&destination=18.6369,73.7508" target="_blank"
                                class="btn btn-sm btn-primary">
                                <i class="fas fa-directions"></i> Get Directions to Pharmacy
                            </a>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('patient.history') }}" class="btn btn-outline-secondary">Back</a>
                            <button type="submit" class="btn btn-success btn-lg">Order Selected Medicines</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('input[name="delivery_type"]').forEach((elem) => {
        elem.addEventListener("change", function (event) {
            var mapDiv = document.getElementById("pharmacyMap");
            var btnDiv = document.getElementById("pharmacyDirBtn");
            if (event.target.value === "pickup") {
                mapDiv.style.display = "block";
                btnDiv.style.display = "block";
                initPharmacyMap();
            } else {
                mapDiv.style.display = "none";
                btnDiv.style.display = "none";
            }
        });
    });

    let pMapInitialized = false;
    let deliveryMapInitialized = false;
    let selectedLat = null;
    let selectedLng = null;
    let deliveryMarker = null;

    document.querySelectorAll('input[name="delivery_type"]').forEach((elem) => {
        elem.addEventListener("change", function (event) {
            var pharmacyMapDiv = document.getElementById("pharmacyMap");
            var pharmacyBtnDiv = document.getElementById("pharmacyDirBtn");
            var deliveryMapDiv = document.getElementById("deliveryMapContainer");

            if (event.target.value === "pickup") {
                pharmacyMapDiv.style.display = "block";
                pharmacyBtnDiv.style.display = "block";
                deliveryMapDiv.style.display = "none";
                initPharmacyMap();
            } else {
                pharmacyMapDiv.style.display = "none";
                pharmacyBtnDiv.style.display = "none";
                deliveryMapDiv.style.display = "block";
                initDeliveryMap();
            }
        });
    });

    // Initialize Delivery Map by default if Home Delivery is checked
    document.addEventListener("DOMContentLoaded", function () {
        if (document.getElementById('del1').checked) {
            document.getElementById("deliveryMapContainer").style.display = "block";
            initDeliveryMap();
        }
    });

    function initPharmacyMap() {
        if (pMapInitialized) return;
        var lat = 18.6369;
        var lng = 73.7508;
        var map = L.map('pharmacyMap').setView([lat, lng], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        L.marker([lat, lng]).addTo(map).bindPopup("<b>Central Pharmacy</b><br>Punawale, Pune").openPopup();
        pMapInitialized = true;
    }

    function initDeliveryMap() {
        if (deliveryMapInitialized) return;

        // Default to Pune or User's profile location if available (can be injected via template)
        var lat = 18.5204;
        var lng = 73.8567;

        var map = L.map('deliveryMap').setView([lat, lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

        // Draggable Marker
        deliveryMarker = L.marker([lat, lng], { draggable: true }).addTo(map);

        deliveryMarker.bindPopup("<b>Drag to your location</b>").openPopup();

        // Initialize hidden inputs with default location immediately
        updateLocationInputs(lat, lng);

        deliveryMarker.on('dragend', function (e) {
            var position = deliveryMarker.getLatLng();
            updateLocationInputs(position.lat, position.lng);
        });

        map.on('click', function (e) {
            deliveryMarker.setLatLng(e.latlng);
            updateLocationInputs(e.latlng.lat, e.latlng.lng);
        });

        // Try getting current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLat = position.coords.latitude;
                var userLng = position.coords.longitude;
                map.setView([userLat, userLng], 15);
                deliveryMarker.setLatLng([userLat, userLng]);
                updateLocationInputs(userLat, userLng);
            });
        }

        deliveryMapInitialized = true;
    }

    function updateLocationInputs(lat, lng) {
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;
        // Optional: Reverse geocode here to fill address text area
    }
</script>
{% endblock %}